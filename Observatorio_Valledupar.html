<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Observatorio Financiero Valledupar</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
    /* -------- INTRO -------- */
    #intro {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: #0D1117;
        color: #3B82F6;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        animation: fadeOut 1s forwards 4s;
    }

    @keyframes fadeOut {
        to { opacity: 0; visibility: hidden; }
    }

    #intro h1 {
        font-size: 2.5em;
        margin-bottom: 12px;
        animation: fadeInDown 1s ease;
    }

    #intro p {
        margin: 0;
        color: #9DA5B4;
    }

    @keyframes pop {
        0% { transform: scale(0); }
        100% { transform: scale(1); }
    }

    /* -------- RESTO DE LA WEB -------- */
    body {
        margin: 0;
        font-family: 'Poppins', sans-serif;
        background: #0D1117;
        color: #E6E6E6;
        overflow-x: hidden;
    }

    header {
        background: linear-gradient(120deg, #0D1117, #0D1117);
        color: #3B82F6;
        padding: 40px 20px;
        text-align: center;
        animation: fadeInDown 1s ease-out;
        border-bottom: 2px solid #3B82F6;
    }

    @keyframes fadeInDown {
        from { opacity: 0; transform: translateY(-40px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .contenedor {
        width: 90%;
        max-width: 1200px;
        margin: 40px auto;
        background: #0D1117;
        padding: 30px;
        border-radius: 16px;
        box-shadow: 0 0 30px rgba(59,130,246,0.3);
        animation: fadeInUp 1s ease-out;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(40px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .tab-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 25px;
        justify-content: center;
    }

    .tab-btn {
        background: #0D1117;
        border: 1px solid #3B82F6;
        color: #3B82F6;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .tab-btn:hover {
        background:#60A5FA;
        color: #0D1117;
        box-shadow: 0 0 15px rgba(59,130,246,0.3);
    }

    .tab-btn.active {
        background: linear-gradient(90deg, #2563EB, #1D4ED8);
        color: #E6E6E6;
        box-shadow: 0 0 20px rgba(59,130,246,0.3);
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.8s ease-in-out;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.98); }
        to { opacity: 1; transform: scale(1); }
    }

    input, button, textarea, select {
        padding: 10px;
        margin: 8px;
        border-radius: 6px;
        border: 1px solid #9DA5B4;
        background: #0D1117;
        color: #E6E6E6;
        font-family: 'Poppins', sans-serif;
    }

    button {
        background: linear-gradient(90deg, #2563EB, #1D4ED8);
        color: #E6E6E6;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
    }

    button:hover {
        background: #60A5FA;
        color: #0D1117;
        box-shadow: 0 0 15px rgba(59,130,246,0.3);
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        font-size: 14px;
        animation: fadeIn 1s ease;
    }

    table th, table td {
        border: 1px solid #9DA5B4;
        padding: 10px;
        text-align: center;
    }

    table th {
        background: #3B82F6;
        color: #0D1117;
    }

    table tr:nth-child(even) {
        background: #0D1117;
    }

    #resumen {
        margin-top: 20px;
        padding: 15px;
        background: #0D1117;
        border-left: 4px solid #3B82F6;
        color: #3B82F6;
        font-weight: bold;
    }

    canvas {
        background: #0D1117;
        border-radius: 10px;
        padding: 10px;
        max-height: 360px;
    }

    ul {
        padding-left: 20px;
    }

    li {
        margin-bottom: 10px;
    }

    .fadeText {
        animation: fadeInUp 1.2s ease;
    }

    .banco-logo {
        width: 24px;
        height: 24px;
        vertical-align: middle;
        margin-right: 8px;
        filter: drop-shadow(0 0 2px #3B82F6);
    }

    /* -------- CLASES FALTANTES -------- */
    .oculto { display: none; }
    .fade-in { animation: fadeIn 1s ease; }
    .success-glow { box-shadow: 0 0 20px rgba(59,130,246,0.3); transition: box-shadow 1s ease; }
    .error-input { border: 1px solid #ff4d4d !important; }
    .shake { animation: shake 0.3s; }
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }

    /* minor layout for news / contact rows */
    .row {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: flex-start;
    }
    .col {
        flex: 1 1 300px;
        min-width: 250px;
    }

    .card {
        background: #0D1117;
        padding: 18px;
        border-radius: 12px;
        margin-bottom: 18px;
        border: 1px solid rgba(59,130,246,0.3);
    }

    .news-item {
        padding: 10px 12px;
        border-left: 3px solid #3B82F6;
        background: #0D1117;
        margin-bottom: 8px;
        border-radius: 6px;
    }

    .small-muted { color: #9DA5B4; font-size: 0.9rem; }

</style>
</head>
<body>

<!-- -------- INTRO CON LOGOS -------- -->
<div id="intro">
    <h1>Observatorio Financiero Valledupar</h1>
    <p>Cargando experiencia financiera...</p>
</div>

<!-- -------- CONTENIDO PRINCIPAL -------- -->
<header>
    <h1>Observatorio Financiero Valledupar</h1>
    <p style="font-size: 1.2em; color: #9DA5B4;">Simulador bancario con interés compuesto exacto</p>
</header>

<div class="contenedor">
    <div class="tab-buttons">
        <button class="tab-btn active" data-tab="inicio">Inicio</button>
        <button class="tab-btn" data-tab="bancos">Bancos</button>
        <button class="tab-btn" data-tab="comparador">Comparador</button>
        <button class="tab-btn" data-tab="glosario">Glosario</button>
        <button class="tab-btn" data-tab="analisis">Análisis</button>
        <button class="tab-btn" data-tab="simulador">Simulador</button>
        <button class="tab-btn" data-tab="graficos">Gráficos</button>
        <button class="tab-btn" data-tab="noticias">Noticias</button>
        <button class="tab-btn" data-tab="contacto">Contacto</button>
    </div>

    <div id="inicio" class="tab-content active fadeText">
        <h2>Bienvenido al Observatorio Financiero</h2>
        <p>Bienvenido al Observatorio Financiero Local de Valledupar, una iniciativa académica de la Universidad de Santander (UDES), Facultad de Ciencias Económicas y Administrativas, curso de Instituciones Financieras – Sexto Semestre.</p>
        <p>Nuestro propósito es ofrecer información clara, confiable y comparativa sobre los bancos presentes en la ciudad, sus tasas de interés, los productos financieros más utilizados y los conceptos clave para tomar decisiones responsables y bien informadas.</p>
    </div>

    <div id="bancos" class="tab-content fadeText">
        <h2>Bancos en Valledupar</h2>
        <ul>
            <li>
                <b>Bancolombia:</b> Entidad financiera privada, vigilada por la Superintendencia Financiera de Colombia. Ofrece productos para personas y empresas. Productos destacados: Cuenta de ahorro, créditos de consumo e hipotecarios, CDT digital, tarjeta de crédito Mastercard y Visa. - Centro, Calle 16 # 9-50. Horario: Lunes a viernes 8:00 a.m. – 4:00 p.m. / Sábados 9:00 a.m. – 12:00 p.m.
            </li>
            <li>
                <b>Banco de Bogotá:</b> Perfil institucional: Una de las entidades bancarias más antiguas del país, con servicios de crédito, ahorro y banca empresarial.
                Productos destacados: Créditos de libre inversión, tarjeta de crédito, CDT tradicional.
                Canales digitales: Banca Móvil, Oficina Virtual.
                Sucursal en Valledupar:
                Dirección: Carrera 9 # 16-20, Centro
                Horario: Lunes a viernes 8:00 a.m. – 3:30 p.m.
            </li>
            <li>
                <b>Davivienda:</b> Perfil institucional: Entidad con amplia presencia nacional y soluciones digitales para personas y negocios.
                Productos destacados: Crédito de consumo “Libranza”, ahorro digital, CDT desde $100.000, tarjetas de crédito y microcrédito.
                Canales digitales: App Davivienda, Daviplata, Oficina virtual.
                Sucursal en Valledupar:
                Dirección: Calle 16 # 9-60
                Horario: Lunes a viernes 8:00 a.m. – 4:00 p.m. / Sábados 9:00 a.m. – 12:00 p.m.
            </li>
            <li>
                <b>BBVA:</b> Perfil institucional: Entidad internacional con enfoque digital y productos competitivos para crédito y ahorro.
                Productos destacados: Crédito de libre inversión, CDT con renovación automática, tarjetas Visa, cuenta digital sin cuota de manejo.
                Canales digitales: App BBVA, Banca Online.
                Sucursal en Valledupar:
                Dirección: Centro Comercial Mayales Plaza
                Horario: Lunes a viernes 9:00 a.m. – 4:00 p.m.
            </li>
            <li>
                <b>Banco Agrario:</b> Perfil institucional: Banco estatal, enfocado en desarrollo rural, microcréditos y financiamiento agrícola.
                Productos destacados: Créditos para emprendedores, microcrédito, ahorro tradicional, CDT.
                Canales digitales: App Banco Agrario, Sucursal Virtual.
                Sucursal en Valledupar:
                Dirección: Carrera 12 # 15-30, Centro
                Horario: Lunes a viernes 8:00 a.m. – 4:00 p.m.
            </li>
        </ul>
    </div>

    <div id="comparador" class="tab-content fadeText">
      <h2>Comparador de Tasas</h2>

      <!-- PRIMERA TABLA: TASAS DE CRÉDITO -->
      <table id="tablaComparador">
        <tr>
          <th>Banco</th>
          <th>Tasa de Interés<br>Efectiva Anual (E.A.)</th>
          <th>Tasa de Usura Vigente<br>(Tope Regulatorio)</th>
          <th>Observaciones</th>
        </tr>

        <tr data-tasa="24.33">
          <td>Bancolombia</td>
          <td>24,33% E.A.</td>
          <td>43% (Tope 2025)</td>
          <td>Ofrece plazos amplios y trámites digitales.</td>
        </tr>

        <tr data-tasa="24.75">
          <td>Banco de Bogotá</td>
          <td>24,75% E.A.</td>
          <td>43% (Tope 2025)</td>
          <td>Enfoque en líneas de crédito rotatorio.</td>
        </tr>

        <tr data-tasa="24.90">
          <td>Davivienda</td>
          <td>24,9% E.A.</td>
          <td>43% (Tope 2025)</td>
          <td>Proceso de aprobación digital y Daviplata.</td>
        </tr>

        <tr data-tasa="24.98">
          <td>BBVA</td>
          <td>24,98% E.A.</td>
          <td>43% (Tope 2025)</td>
          <td>Plazos flexibles y cuenta digital sin cuota.</td>
        </tr>

        <tr data-tasa="23.87">
          <td>Banco Agrario</td>
          <td>23,87% E.A.</td>
          <td>43% (Tope 2025)</td>
          <td>Foco en microcrédito y desarrollo rural.</td>
        </tr>

        <!-- FILA DE ANÁLISIS -->
        <tr>
          <td><b>Análisis Central</b></td>
          <td colspan="3" style="text-align:left; background:#0D1117; color:#3B82F6;">
            La tasa de usura es el límite máximo legal que pueden cobrar los bancos en Colombia.
            Mantener tasas por debajo de este umbral demuestra estabilidad y competencia en el mercado
            de crédito en Valledupar.
          </td>
        </tr>
      </table>

      <!-- SEGUNDA TABLA: TASAS CDT (90,180,360 días) -->
      <table id="tablaCDT">
        <tr>
          <th>Banco</th>
          <th>Tasa a 90 días (E.A.)</th>
          <th>Tasa a 180 días (E.A.)</th>
          <th>Tasa a 360 días (E.A.)</th>
          <th>Observaciones</th>
        </tr>

        <tr>
          <td>Bancolombia</td>
          <td>8.3% E.A.</td>
          <td>9.0% E.A.</td>
          <td>10.1% E.A.</td>
          <td>Mejores tasas digitales para ahorro a largo plazo.</td>
        </tr>

        <tr>
         <td>Banco de Bogotá</td>
          <td>8.55% E.A.</td>
          <td>8.8% E.A.</td>
          <td>9.8% E.A.</td>
          <td>Permite negociar el título valor en mercado secundario.</td>
        </tr>

        <tr>
         <td>Davivienda</td>
          <td>8.15% E.A.</td>
          <td>8.7% E.A.</td>
          <td>9.9% E.A.</td>
          <td>CDT desde $100.000, accesible para pequeños ahorradores.</td>
        </tr>

        <tr>
         <td>BBVA</td>
          <td>8.35% E.A.</td>
          <td>8.9% E.A.</td>
          <td>10.0% E.A.</td>
          <td>Opción de renovación automática.</td>
        </tr>

        <tr>
         <td>Banco Agrario</td>
          <td>8.15% E.A.</td>
          <td>8.5% E.A.</td>
          <td>9.6% E.A.</td>
          <td>Atracción para pequeños productores y rurales.</td>
        </tr>

        <!-- FILA DE ANÁLISIS -->
        <tr>
          <td><b>Análisis Central</b></td>
          <td colspan="4" style="text-align:left; background:#0D1117; color: #3B82F6;">
            Las decisiones de política monetaria del Banco de la República influyen directamente en la tasa
            de captación del sistema bancario. En Valledupar, la competencia por el ahorro se refleja en tasas
            similares y productos digitales que facilitan la inversión.
          </td>
        </tr>
      </table>

    </div>

    <div id="glosario" class="tab-content fadeText">
        <h2>Glosario Financiero</h2>
        <p></b>1.Inflación objetivo: Estrategia del Banco de la República para mantener la inflación entre 2% y 4%.</p>
        <p></b>2.Tasa de intervención: Tasa de interés fijada por el Banco de la República que afecta el costo del crédito.</p>
        <p></b>3.Tasa de usura: Límite máximo que puede cobrarse por intereses en un crédito.</p>
        <p></b>4.Crédito de consumo: Préstamo destinado a necesidades personales del hogar.</p>
        <p></b>5.CDT: Depósito a término fijo con rentabilidad asegurada.</p>
        <p></b>6.Interés E.A.: Interés expresado en tasa efectiva anual.</p>
        <p></b>7.Sistema Financiero: Conjunto de bancos y entidades que manejan dinero en un país.</p>
        <p></b>8.SARLAFT: Sistema para prevenir lavado de activos y financiación del terrorismo.</p>
        <p></b>9.Liquidez: Capacidad de una entidad para cumplir sus obligaciones sin pérdidas.</p>
        <p></b>10.Fintech: Empresas que usan tecnología para ofrecer servicios financieros.</p>
        <p></b>11.Cartera vencida: Créditos que los clientes no han pagado.</p>
        <p></b>12.Microcrédito: Financiamiento para pequeños negocios.</p>
        <p></b>13.Tasa pasiva: Interés que pagan los bancos por captar dinero (CDT, ahorro).</p>
        <p></b>14.Tasa activa: Interés cobrado en préstamos y créditos.</p>
        <p></b>15.Ahorro programado: Meta de ahorro con consignaciones periódicas.</p>
        <p></b>16.Solvencia: Capacidad del banco para responder con su patrimonio.</p>
        <p></b>17.Basilea III: Reglas internacionales para estabilidad bancaria.</p>
        <p></b>18.Riesgo de crédito: Probabilidad de que un cliente no pague.</p>
        <p></b>19.Morosidad: Estado de retraso en pagos.</p>
        <p></b>20.Crédito rotativo: Línea de crédito que se usa y se repone al pagar.</p>
    </div>

    <div id="analisis" class="tab-content fadeText">
        <h2>Análisis Económico</h2>
        <p><b>El Impacto de la Desaceleración en el Crédito de Consumo Local (2024-2025)</b></p>
        <p>Durante 2024 y 2025, la política monetaria del Banco de la República mantuvo tasas de interés elevadas para controlar la inflación. Esto ha encarecido el costo del crédito, especialmente el de consumo, afectando a hogares y pequeños negocios de Valledupar.

Los bancos han endurecido sus requisitos de aprobación y han aumentado las provisiones para enfrentar el riesgo de mora. La cartera vencida creció debido al alto endeudamiento posterior a la pandemia, lo que llevó a una desaceleración del crédito.

Aunque las tasas comienzan a reducirse gradualmente, los bancos locales continúan priorizando clientes con historial sólido. La banca digital y las fintech son una alternativa importante gracias a procesos rápidos y menores costos operativos.</p>
    </div>

    <!-- SIMULADOR (MEJORADO: MÁS PRECISIÓN SIN CAMBIAR LA ESTRUCTURA GENERAL) -->
    <div id="simulador" class="tab-content fadeText">
      <div class="card">
        <label for="montoConversion">Monto del préstamo ($)</label>
        <input type="number" id="montoConversion" placeholder="Ej: 5000000" min="1">

        <label for="tea">Tasa Efectiva Anual (TEA %)</label>
        <input type="number" id="tea" placeholder="Ej: 28.5" min="0.0000001" step="0.0000001">

        <label for="periodosAno">Periodos por año</label>
        <input type="number" id="periodosAno" placeholder="Ej: 12" min="1" max="365" step="1">

        <label for="plazoConversion">Plazo total (periodos)</label>
        <input type="number" id="plazoConversion" placeholder="Ej: 12" min="1" step="1">

        <button id="btnCalcular" onclick="calcularConversion()">Calcular</button>

        <div id="resultadoConversion" class="oculto"></div>
      </div>

      <div id="tablaCardConversion" class="card oculto">
        <h2 style="color: #3B82F6; margin-top: 0;">Tabla de amortización</h2>
        <table id="tablaAmortizacionConversion">
          <thead>
            <tr>
              <th>Período</th>
              <th>Cuota ($)</th>
              <th>Interés ($)</th>
              <th>Abono ($)</th>
              <th>Saldo ($)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="graficos" class="tab-content fadeText">
        <h2>Gráfico de Tasas</h2>
        <div class="card">
            <canvas id="graf" width="600" height="320"></canvas>
            <p class="small-muted">La gráfica muestra las tasas E.A. listadas en el comparador. Si cambias las tasas en la tabla del comparador, abre de nuevo esta pestaña para actualizar la gráfica.</p>
        </div>
    </div>

    <div id="noticias" class="tab-content fadeText">
        <h2>Noticias</h2>
        <div class="row">
            <div class="col">
                <div id="listaNoticias" class="card">
                    <p class="small-muted">No hay noticias aún. Usa el formulario de la derecha para añadirlas (tus noticias no se envían a internet, quedan en la sesión del navegador mientras la página esté abierta).</p>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <h3>Añadir noticia</h3>
                    <label for="tituloNoticia">Título</label><br>
                    <input id="tituloNoticia" type="text" placeholder="Título de la noticia">
                    <label for="textoNoticia">Contenido / Enlace</label><br>
                    <textarea id="textoNoticia" rows="4" placeholder="Texto breve o enlace"></textarea>
                    <button id="btnAgregarNoticia">Agregar noticia</button>
                    <button id="btnLimpiarNoticias" style="background:#0D1117;color:#E6E6E6;margin-left:8px;">Limpiar noticias</button>
                    <p class="small-muted" style="margin-top:8px;">Pegarás aquí la información que mencionaste que pondrás tú.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="contacto" class="tab-content fadeText">
        <h2>Contacto</h2>
        <div class="row">
            <div class="col">
                <div class="card">
                    <p>Universidad de Santander (UDES)</p>
                    <p>Instituciones Financieras – Sexto Semestre</p>
                    <p>Email: <span style="color: #3B82F6;">observatorio.financiero@udes.edu.co</span></p>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <h3>Enviar mensaje</h3>
                    <label for="contactName">Nombre</label><br>
                    <input id="contactName" type="text" placeholder="Tu nombre">
                    <label for="contactEmail">Email</label><br>
                    <input id="contactEmail" type="email" placeholder="correo@ejemplo.com">
                    <label for="contactMsg">Mensaje</label><br>
                    <textarea id="contactMsg" rows="4" placeholder="Escribe tu mensaje"></textarea>
                    <div>
                        <button id="btnEnviarContacto">Enviar</button>
                        <span id="contactFeedback" style="margin-left:12px;"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// -------- INTRO AUTO-OCULTABLE --------
setTimeout(() => {
    const intro = document.getElementById("intro");
    if (intro) intro.style.display = "none";
}, 4000);

// -------- TABS --------
document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
        btn.classList.add("active");
        const target = document.getElementById(btn.dataset.tab);
        if (target) target.classList.add("active");
        if (btn.dataset.tab === 'graficos') {
            setTimeout(()=> { tryRenderChart(); }, 100);
        }
    });
});

/* ========================
   UTILIDADES NUMÉRICAS
   ======================== */
function toCents(num) {
  // convierte a centavos evitando errores binarios
  return Math.round((Number(num) || 0) * 100);
}
function fromCents(cents) {
  return (cents || 0) / 100;
}
function fmtMoney(n) {
  // muestra como moneda CO sin símbolo para mantener estilo previo
  return new Intl.NumberFormat('es-CO', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);
}
function clampInt(v, min, max) {
  v = Math.floor(Math.abs(v));
  if (min !== undefined && v < min) v = min;
  if (max !== undefined && v > max) v = max;
  return v;
}

/* ================================================
   SIMULADOR con amortización de alta precisión
   - Cálculos en centavos para evitar errores float
   - Ajuste de última cuota para eliminar residuo
   - Uso de log1p/expm1 para mayor precisión numérica
   - Se muestra la cuota fija objetivo (sin el ajuste de la última)
   ================================================ */
function mostrarError(campo, mensaje) {
  campo.classList.add("error-input", "shake");
  setTimeout(() => campo.classList.remove("shake"), 300);
  if (!campo.nextElementSibling || !campo.nextElementSibling.classList.contains("error-msg")) {
    const msg = document.createElement("span");
    msg.className = "error-msg";
    msg.style.color = "#ff4d4d";
    msg.style.fontSize = "0.85rem";
    msg.textContent = mensaje;
    campo.parentNode.insertBefore(msg, campo.nextSibling);
  }
}

function limpiarErrores() {
  document.querySelectorAll(".error-input").forEach(el => el.classList.remove("error-input"));
  document.querySelectorAll(".error-msg").forEach(el => el.remove());
}

async function calcularConversion() {
  limpiarErrores();

  const P = Number(document.getElementById("montoConversion").value);
  const TEA = Number(document.getElementById("tea").value);
  let m = Number(document.getElementById("periodosAno").value);
  let n = Number(document.getElementById("plazoConversion").value);

  let valido = true;
  if (!P || P <= 0) { mostrarError(document.getElementById("montoConversion"), "Monto debe ser > 0"); valido = false; }
  if (!TEA || TEA <= 0) { mostrarError(document.getElementById("tea"), "TEA debe ser > 0"); valido = false; }
  if (!m || m <= 0) { mostrarError(document.getElementById("periodosAno"), "Periodos/año debe ser ≥ 1"); valido = false; }
  if (!n || n <= 0) { mostrarError(document.getElementById("plazoConversion"), "Plazo debe ser ≥ 1"); valido = false; }
  if (!valido) return;

  // sanea a enteros razonables
  m = clampInt(m, 1, 365);
  n = clampInt(n, 1, 2000);

  const btn = document.getElementById("btnCalcular");
  btn.disabled = true;
  btn.textContent = "Calculando...";

  await new Promise(r => setTimeout(r, 150));

  // Tasa periódica EXACTA a partir de TEA y m, con mayor precisión numérica
  // i_p = (1+TEA)^(1/m) - 1  -> usando log1p/expm1 para estabilidad
  const tea_decimal = TEA / 100;
  const i_periodica = Math.expm1(Math.log1p(tea_decimal) / m);
  const TEN = i_periodica * m; // nominal equivalente informativa

  // Factor (1+i)^n calculado con exp/log para estabilidad
  const factor = Math.exp(n * Math.log1p(i_periodica));

  // Cuota teórica (sin redondeo), y versión a centavos para la tabla
  const cuota_teorica = (P * i_periodica * factor) / (factor - 1);
  const cuota_cents_objetivo = toCents(cuota_teorica);
  let cuota_cents = cuota_cents_objetivo; // se usará y ajustará en el último período

  // Construir tabla amortizando en centavos
  const P_cents = toCents(P);
  let saldo_cents = P_cents;
  const tbody = document.querySelector("#tablaAmortizacionConversion tbody");
  tbody.innerHTML = "";

  for (let k = 1; k <= n; k++) {
    // Interés del período redondeado a centavos
    let interes_cents = Math.round(saldo_cents * i_periodica);

    // Para la última cuota, ajusta para cerrar saldo exactamente en 0
    if (k === n) {
      cuota_cents = saldo_cents + interes_cents;
    }

    let abono_cents = cuota_cents - interes_cents;
    if (abono_cents < 0) abono_cents = 0;

    saldo_cents = saldo_cents - abono_cents;
    if (saldo_cents < 0) saldo_cents = 0;

    const fila = document.createElement("tr");
    fila.innerHTML = `
      <td>${k}</td>
      <td>$${fmtMoney(fromCents(cuota_cents))}</td>
      <td>$${fmtMoney(fromCents(interes_cents))}</td>
      <td>$${fmtMoney(fromCents(abono_cents))}</td>
      <td>$${fmtMoney(fromCents(saldo_cents))}</td>
    `;
    fila.style.opacity = "0";
    tbody.appendChild(fila);
    setTimeout(() => fila.style.opacity = "1", k * 15);
  }

  const resDiv = document.getElementById("resultadoConversion");
  resDiv.innerHTML = `
    <div class="fade-in">
      <p><strong>Tasa Efectiva Anual (TEA):</strong> ${TEA.toFixed(8)}%</p>
      <p><strong>Tasa efectiva periódica:</strong> ${(i_periodica * 100).toFixed(8)}%</p>
      <p><strong>Tasa nominal equivalente (TEN):</strong> ${(TEN * 100).toFixed(8)}%</p>
      <p><strong>Cuota fija objetivo*:</strong> $${fmtMoney(fromCents(cuota_cents_objetivo))}</p>
      <p class="small-muted">*La última cuota puede variar levemente para cerrar el saldo exacto al centavo.</p>
    </div>
  `;
  resDiv.classList.remove("oculto");
  resDiv.classList.add("success-glow");
  setTimeout(() => resDiv.classList.remove("success-glow"), 900);

  const tablaCard = document.getElementById("tablaCardConversion");
  tablaCard.classList.remove("oculto");
  tablaCard.classList.add("fade-in");
  tablaCard.scrollIntoView({ behavior: "smooth", block: "start" });

  btn.disabled = false;
  btn.textContent = "Calcular";
}

/* -------- GRÁFICA (Chart.js) -------- */
let tasaChart = null;
function parsePercentEs(texto) {
    // extrae primer número y convierte coma decimal a punto
    const m = (texto || '').match(/[\d.,]+/);
    if (!m) return NaN;
    const normalized = m[0].replace(/\./g,'').replace(',', '.');
    return parseFloat(normalized);
}
function collectRatesFromTable() {
    const rows = Array.from(document.querySelectorAll("#tablaComparador tr")).filter(r => r.dataset && ('tasa' in r.dataset));
    const labels = [];
    const tasas = [];
    rows.forEach(r => {
        const nameCell = r.children[0]?.innerText || 'Banco';
        // Prioriza data-tasa; si no, intenta leer de la celda de E.A.
        let tasa = parseFloat(r.dataset.tasa);
        if (isNaN(tasa)) {
            tasa = parsePercentEs(r.children[1]?.innerText || '');
        }
        labels.push(nameCell.replace(/\n/g, ' ').trim());
        tasas.push(isNaN(tasa) ? 0 : tasa);
    });
    return { labels, tasas };
}

function tryRenderChart() {
    const ctx = document.getElementById('graf');
    if (!ctx) return;
    const data = collectRatesFromTable();
    if (tasaChart) {
        try { tasaChart.destroy(); } catch(e) {}
        tasaChart = null;
    }
    tasaChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.labels,
            datasets: [{
                label: 'Tasa E.A. (%)',
                data: data.tasas,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: function(v){ return v + '%'; } }
                }
            },
            plugins: {
                legend: { display: false }
            }
        }
    });
}

document.addEventListener('DOMContentLoaded', () => {
    tryRenderChart();
    loadNoticiasFromSession();
    const addBtn = document.getElementById('btnAgregarNoticia');
    if (addBtn) addBtn.addEventListener('click', agregarNoticia);
    const clrBtn = document.getElementById('btnLimpiarNoticias');
    if (clrBtn) clrBtn.addEventListener('click', limpiarNoticias);
    const sendBtn = document.getElementById('btnEnviarContacto');
    if (sendBtn) sendBtn.addEventListener('click', enviarContacto);
});

/* -------- NOTICIAS -------- */
function renderNoticias(list) {
    const container = document.getElementById('listaNoticias');
    container.innerHTML = '';
    if (!list || list.length === 0) {
        container.innerHTML = '<p class="small-muted">No hay noticias aún. Usa el formulario para añadirlas.</p>';
        return;
    }
    list.slice().reverse().forEach((item) => {
        const div = document.createElement('div');
        div.className = 'news-item';
        div.innerHTML = `<strong>${item.titulo || 'Sin título'}</strong>
                         <div style="font-size:0.95rem;margin-top:6px;">${item.texto || ''}</div>
                         <div style="margin-top:6px;font-size:0.8rem;color:#9DA5B4;">${item.fecha || ''}</div>`;
        container.appendChild(div);
    });
}
function agregarNoticia() {
    const t = document.getElementById('tituloNoticia').value.trim();
    const txt = document.getElementById('textoNoticia').value.trim();
    if (!t && !txt) { alert('Ingresa un título o contenido para la noticia.'); return; }
    const noticia = { titulo: t, texto: txt, fecha: new Date().toLocaleString() };
    const list = getNoticiasFromSession();
    list.push(noticia);
    sessionStorage.setItem('observatorio_noticias', JSON.stringify(list));
    document.getElementById('tituloNoticia').value = '';
    document.getElementById('textoNoticia').value = '';
    renderNoticias(list);
}
function getNoticiasFromSession() {
    try { const s = sessionStorage.getItem('observatorio_noticias'); return s ? JSON.parse(s) : []; }
    catch (e) { return []; }
}
function loadNoticiasFromSession() { renderNoticias(getNoticiasFromSession()); }
function limpiarNoticias() {
    if (!confirm('¿Limpiar todas las noticias?')) return;
    sessionStorage.removeItem('observatorio_noticias');
    loadNoticiasFromSession();
}

/* -------- CONTACTO -------- */
function enviarContacto() {
    const name = document.getElementById('contactName');
    const email = document.getElementById('contactEmail');
    const msg = document.getElementById('contactMsg');
    const feedback = document.getElementById('contactFeedback');

    feedback.textContent = '';
    name.classList.remove('error-input');
    email.classList.remove('error-input');
    msg.classList.remove('error-input');

    let ok = true;
    if (!name.value.trim()) { name.classList.add('error-input'); ok = false; }
    if (!email.value.trim() || !/^\\S+@\\S+\\.\\S+$/.test(email.value.trim())) { email.classList.add('error-input'); ok = false; }
    if (!msg.value.trim()) { msg.classList.add('error-input'); ok = false; }

    if (!ok) {
        feedback.style.color = '#ff4d4d';
        feedback.textContent = 'Completa correctamente los campos resaltados.';
        return;
    }

    feedback.style.color = '#ffd700';
    feedback.textContent = 'Enviado localmente. Gracias — (esto es una simulación).';

    setTimeout(() => {
        name.value = ''; email.value = ''; msg.value = '';
        setTimeout(()=> feedback.textContent = '', 3500);
    }, 400);
}
</script>
</body>
</html>
